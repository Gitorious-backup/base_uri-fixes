<%= gravatar message.sender.email, :size => 20 -%>
<div class="message">
  <p class="sender">
    <% if message.recipient == current_user %>
      To <strong>You</strong>
    <% else %>
      From <%=link_to(h(message.sender.fullname), user_path(message.sender)) -%>
    <% end %>
    <%= distance_of_time_in_words_to_now(message.created_at) %> ago
  </p>
  <p class="subject">
    <%= link_to h(message.subject), message_path(message) %>
  </p>
  <div class="body">
    <%= simple_format(h(message.body)) %>
  </div>
  
  <% if message.unread? and message.recipient == current_user %>
    <%= link_to_remote(t('views.messages.mark_as_read'), :url => read_message_path(message), :method => :put) %>
  <% end %>
  
  <%- if original_message = message.in_reply_to -%>
    <div>
      This is in reply to <%= link_to(h(original_message.subject), message_path(original_message)) %>
    </div>
  <%- end -%>
  
  <%= render :partial => "replies", :locals => {:replies => message.replies}  %>

  
  <% unless message.sender == current_user -%>
    <p>
      <%= link_to_function(t("views.messages.reply"), "Element.toggle('#{dom_id(message,"reply_to")}')") %>
    </p>
    <div class="reply" style="display:none" id="<%= dom_id(message,"reply_to") %>">
      <% form_for(message.build_reply, :url => reply_message_path(message)) do |f| %>
        <p>
          <%= f.label :subject, t("views.messages.subject") %><br/>
          <%= f.text_field :subject %>
        </p>
        <p>
          <%= f.label :subject, t("views.messages.body") %><br/>
          <%= f.text_area :body %>
        </p>

        <p>
          <%= f.submit t("views.messages.submit") %>
        </p>
      <% end %>
    </div>
  <% end %>

</div>