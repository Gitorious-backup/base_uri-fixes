<% @page_title = @project.title -%>
<h1><%=h @project.title -%></h1>

<div class="infobox">
  <ul>
    <li><strong>Labels:</strong> 
      <%= @project.tag_list.blank? ? "none" : linked_tag_list_as_sentence(@project.tags) -%></li>
    <li><strong>License:</strong> <%= h(@project.license) -%></li>
    <li><strong>Owner:</strong> <%= link_to h(@project.user.login), user_path(@project.user) -%></li>
    <li><strong>Created:</strong> <%= @project.created_at.to_s(:short) -%></li>
    <% unless @project.home_url.blank? -%>
    <li><strong>Website at </strong> 
      <%= link_to base_url(@project.home_url), h(@project.home_url) -%></li>
    <% end -%>
    <% unless @project.mailinglist_url.blank? -%>
    <li><strong>Mailinglist at </strong> 
      <%= link_to base_url(@project.mailinglist_url), h(@project.mailinglist_url) -%></li>
    <% end -%>
    <% unless @project.bugtracker_url.blank? -%>
    <li><strong>Bugtracker at </strong> 
      <%= link_to base_url(@project.bugtracker_url), h(@project.bugtracker_url) -%></li>
    <% end -%>
    <% if @repositories.first.has_commits? %>
    <li><%= image_tag("/projects/commit_graph/#{@project.slug}?width=250") %></li>
    <% end -%>
  </ul>
</div>

<div class="page">
  <%= auto_link(markdown(sanitize(@project.description)), :urls) -%>
</div>

<h2 class="clear">Associated repositories</h2>
<table class="repository_list listing">
  <thead>
    <th>Name</th>
    <th>Owner</th>
    <th>Last Commit</th>
    <th>Commiter</th>
    <th></th>
    <th></th>
  </thead>
  <% commits = [] %>
  <% repositories = @repositories.sort_by { |e| commits << e.last_commit if e.last_commit; e.mainline? ? Time.now : e.last_commit.committed_date } %>
  <% email_user = RepositoriesHelper.users_by_commits(commits) %>
  <% repositories.reverse_each do |repos| # FIXME: need to graph the parent relation proper -%>
    <% user = email_user[repos.last_commit.committer.email] if repos.has_commits? %>
    <tr class="<%= cycle("even", "odd") -%> <%= repos.mainline? ? "mainline" : "clone" -%>">
      <td class="name">
        <%= link_to h(repos.name), project_repository_path(@project, repos) -%>
      </td>
      <td>
        <%= gravatar(repos.user.email, :size => 16) %>
        <%= link_to h(repos.user.login), user_path(repos.user) -%>
      </td>
      <td>
        <% if repos.has_commits? -%>
          <%= time_ago_in_words(repos.last_commit.committed_date) -%> ago: 
          <small class="commit_message"><%= truncate(h(repos.last_commit.message), 50) -%></small>
        <% else -%>
          <em>none</em>
        <% end -%>
      </td>
      <td>
        <% if user.nil? %>
        <%= repos.last_commit.committer.name if repos.has_commits? %>
        <% else %>
        <%= link_to(user.login, user_path(user)) %>
        <% end -%>
      </td>
      <td><%= link_to "commits", project_repository_log_path(@project, repos) -%></td>
      <td><%= link_to "tree", project_repository_tree_path(@project, repos, 
                repos.has_commits? ? repos.head_candidate.name : "HEAD") -%></td>
    </tr>
  <% end -%>
</table>

<% content_for :submenu do -%>
<% if @project.admin?(current_user) -%>
  <li><%= link_to "Edit project", edit_project_path(@project) -%>)</li>
<% end -%>  
<% end -%>
