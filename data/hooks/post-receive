#!/usr/bin/env ruby

incpath = File.dirname(__FILE__)
$: << incpath

require 'rails_env'
require 'date'

gitdir = File.expand_path(File.join(incpath, ".."))
repository_name = File.basename(gitdir)
slug = ""

if repository_name =~ /\.git$/
  repository_name.sub!(/\.git$/, "")
  slug = File.basename(File.expand_path(File.join(gitdir, "..")))
end

git = Grit::Git.new(gitdir)

while line = gets
  oldrev, newrev, revname = line.split(" ")
  current_rev = newrev
  newtype = oldtype = current_rev_type = "commit"
  
  action = :create
  if oldrev =~ /^0+$/
    action = :create
  else
    if newrev =~ /^0+$/
      action = :delete
    else
      action = :update
    end
  end
  
  if action != :create
    newtype = git.cat_file({:t => true}, newrev)
  end
  
  if action != :delete
    oldtype = git.cat_file({:t => true}, oldrev)
  end
  
  if action == :delete
      current_rev = oldrev
      current_rev_type = oldtype
  end
  
  # type => heads, tags, remotes
  # name => branch name
  path, type, name = revname.split("/")
  
  info = git.show({ :pretty => "format:author: %cn%nemail: %ce%ndate: %cd%nmessage: %s", :s => true}, current_rev )
  
  hash = {}
  info.each { |line|
    if line =~ /(\w+):\s(.*)$/
      key = $1.to_sym
      value = $2
      
      value = Date.parse(value) if key == :date
      
      hash[key] = value
    end
  }
  
  # action => create, delete, update
  # rev_type => commit, tag
  
  puts "#{hash[:author]}: #{action} #{current_rev_type} on #{slug} [#{hash[:date]}]"
  puts "    #{hash[:message]}"
  
  user = User.find_by_email(hash[:email])
  next if user.nil?
  
  project = Project.find_by_slug(slug)
  repository = nil
  
  project.repositories.each { |repo|
    if repo.name == repository_name
      repository = repo
      break
    end
  }
  
  action_name = ""
  ref = nil
  if current_rev_type == "commit"
    if type == "heads"
      case action
        when :create
          action_name = "create branch"
          ref = name
        when :update
          action_name = "commit"
          ref = current_rev
        when :delete
          action_name = "delete branch"
          ref = name
      end
    elsif type == "tags"
      if action == :create
        action_name = "tag"
        ref = name
      end
    end
  elsif current_rev_type == "tag"
    if type == "tags"
      if action == :create
        action_name = "tag"
        ref = name
      end
    end
  end
  
  next if action_name.empty?
  
  action = Action.find_by_name(action_name)
  Event.from_action_name(action_name, user, repository, ref, hash[:message])
end

puts "=> Thanks!"

